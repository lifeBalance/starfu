# How It Works

Starfu scaffolds projects using a manifest-based approach. This page explains the internals.

## Architecture

```sh
starfu/
├── cli/
│   ├── cli.ts        # Entry point, argument parsing, prompts
│   └── scaffold.ts   # File copying and template processing
├── template/         # Template files (a working Astro project)
│   ├── scaffold-manifest.json  # What to copy
│   ├── astro.config.mjs        # Template with placeholders
│   ├── src/                    # Astro components
│   └── docs/                   # Starter content
└── tests/
    ├── cli.test.ts
    └── scaffold.test.ts
```

## The Manifest

Scaffolding is driven by `scaffold-manifest.json`:

```json
[
  {
    "src": "astro.config.mjs",
    "dest": ".starfu/astro.config.mjs",
    "template": true
  },
  { "src": "ec.config.mjs", "dest": ".starfu/ec.config.mjs" },
  { "src": "package.json", "dest": ".starfu/package.json" },
  { "src": "src/", "dest": ".starfu/src/" },
  { "src": "tsconfig.json", "dest": ".starfu/tsconfig.json" },
  { "src": "docs/", "dest": "docs/" }
]
```

### Manifest Fields

| Field      | Description                                   |
| ---------- | --------------------------------------------- |
| `src`      | Source path relative to `template/`           |
| `dest`     | Destination path relative to output directory |
| `template` | If true, process placeholders in this file    |

### Folders vs Files

- Paths ending with `/` are copied recursively
- Paths without `/` are copied as single files

## Template Processing

Files marked with `template: true` have placeholders replaced:

| Placeholder             | Replaced With                   |
| ----------------------- | ------------------------------- |
| `customizable-username` | GitHub username from git remote |
| `customizable-basepath` | Repository name from git remote |

### Example

Before (in `template/astro.config.mjs`):

```js
export default defineConfig({
  site: 'https://customizable-username.github.io/customizable-basepath',
  base: '/customizable-basepath/',
})
```

After scaffolding in a repo named `my-project` owned by `jsmith`:

```js
export default defineConfig({
  site: 'https://jsmith.github.io/my-project',
  base: '/my-project/',
})
```

## Git Remote Detection

The CLI extracts user and repo from the git remote URL:

```bash
git ls-remote --get-url origin
```

Supports both SSH and HTTPS formats:

- `git@github.com:username/repo.git`
- `https://github.com/username/repo.git`

If no remote is found, the folder name is used as the base path, and `your-username` as a placeholder for the username.

## The `template/` Folder

The `template/` folder is a fully functional Astro project. You can:

```bash
cd template
pnpm install
pnpm dev
```

This is useful for developing and testing the docs engine itself. Changes made here become the template for new projects.

## Docs Registry Generation

Starfu allows docs to live **outside** the `.starfu/` folder (e.g., at `your-project/docs/`). This is achieved through a generated registry file.

When the dev server starts or build runs, the integration generates `.starfu/docs-registry.ts`:

```ts
// Auto-generated by docs integration
export const generatedRegistry = {
  'tutorial': {
    content: import.meta.glob('../docs/tutorial/**/*.{md,mdx}', { eager: true }),
    toc: import.meta.glob('../docs/tutorial/**/_toc.ts', { eager: true }),
  },
  // ... other sections
}
```

**Why at the project root?** Vite's `import.meta.glob` resolves paths relative to the file location. By placing the registry at `.starfu/docs-registry.ts`, paths like `../docs/tutorial` correctly resolve to `your-project/docs/tutorial`.

This file is:
- Auto-generated on each dev/build
- Scaffolded as a placeholder initially
- Should not be edited manually

## Scaffolding Flow

1. Parse CLI arguments (`--dir`, `--force`)
2. Read `scaffold-manifest.json`
3. For each manifest entry:
   - Check if destination exists (error unless `--force`)
   - Copy file or folder
4. Read git remote URL (or use folder name as fallback)
5. Replace placeholders in template files
6. Show interactive prompts (if TTY)
