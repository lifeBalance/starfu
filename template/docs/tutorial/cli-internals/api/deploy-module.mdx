# Deploy Module

The deploy module (`cli/deploy.ts`) handles deployment configuration and CI workflow generation.

## runDeploy

Main entry point for the deploy command.

```ts
async function runDeploy(cwd: string): Promise<void>
```

### Parameters

| Parameter | Description |
|-----------|-------------|
| `cwd` | Current working directory (project root) |

### Behavior

1. Detects repository info from git remote
2. If no remote found, offers manual configuration (prompts for platform, username, repo)
3. Updates `astro.config.mjs` with values if configured manually
4. Checks for existing CI workflow
5. Offers to generate workflow if missing
6. Shows deployment summary

## detectRepoInfo

Extracts repository information from git remote.

```ts
function detectRepoInfo(cwd: string): RepoInfo | null

interface RepoInfo {
  platform: 'github' | 'gitlab'
  username: string
  repo: string
}
```

### Parameters

| Parameter | Description |
|-----------|-------------|
| `cwd` | Directory to run git command in |

### Returns

Returns `null` if:
- Not a git repository
- No remote named `origin`
- Remote URL doesn't match GitHub/GitLab pattern

### Supported URL Formats

```
git@github.com:username/repo.git     → { platform: 'github', username, repo }
https://github.com/username/repo.git → { platform: 'github', username, repo }
git@gitlab.com:username/repo.git     → { platform: 'gitlab', username, repo }
https://gitlab.com/username/repo.git → { platform: 'gitlab', username, repo }
```

## detectDefaultBranch

Detects the default branch for the repository.

```ts
function detectDefaultBranch(cwd: string): string
```

### Parameters

| Parameter | Description |
|-----------|-------------|
| `cwd` | Directory to run git commands in |

### Returns

The branch name as a string. Detection order:

1. Remote HEAD (`git symbolic-ref refs/remotes/origin/HEAD`)
2. Current branch (`git branch --show-current`)
3. Fallback: `"main"`

## readWorkflowTemplate

Reads a CI workflow template from the package's `template/workflows/` directory.

```ts
function readWorkflowTemplate(platform: Platform): string
```

### Parameters

| Parameter | Description |
|-----------|-------------|
| `platform` | `'github'` or `'gitlab'` |

### Returns

The raw template string with `%%PLACEHOLDER%%` tokens. The caller replaces `%%DEFAULT_BRANCH%%`, `%%USERNAME%%`, and `%%REPO%%` before writing the file.

### Template Files

| Platform | Template |
|----------|----------|
| GitHub | `template/workflows/github-deploy.yml` |
| GitLab | `template/workflows/gitlab-ci.yml` |

## Dependencies

| Package | Purpose |
|---------|---------|
| `@clack/prompts` | Interactive CLI prompts |
| `node:child_process` | Run git commands |
| `node:fs` | File operations |
